require 'optparse'

# rake download -- -f article_list.csv
task :download do
  require 'csv'
  require_relative 'downloader'

  options = {
    input_file: 'article_list.csv'
  }
  opts = OptionParser.new
  opts.banner = 'Usage: rake download [options]'
  opts.on('-f', '--f FILENAME', 'Input csv file name') { |input_file| options[:input_file] = input_file }
  args = opts.order!(ARGV) {}
  opts.parse!(args)

  puts opts
  puts 'Start downloading...'
  puts '--------------------------------'

  article_list = CSV.read(options[:input_file])

  begin
    Downloader.new(article_list).download
  rescue StandardError => e
    puts "BREAKING: An error of type #{e.class} happened."
    puts e.message

    puts 'Retrying in 10 seconds...'
    sleep(10)
    retry
  end
end

# rake csv -- -f article_list.csv -p ScienceDirect -c agriculture -u https://www.sciencedirect.com/
task :csv do
  require_relative 'scraper'

  options = {
    url: 'https://www.sciencedirect.com/search?show=100&date=2003-2023&articleTypes=FLA&accessTypes=openaccess',
    category: 'agriculture',
    output_file: 'article_list.csv',
    publication: 'ScienceDirect'
  }
  opts = OptionParser.new
  opts.banner = 'Usage: rake csv [options]'
  opts.on('-u', '--u URL', 'URL for article list') { |url| options[:url] = url }
  opts.on('-f', '--f FILENAME', 'Output csv filename') { |output_file| options[:output_file] = output_file }
  opts.on('-c', '--c CATEGORY', 'Category') { |category| options[:category] = category }
  opts.on('-p', '--p PUBLICATION_TITLE', 'Publication title') { |publication| options[:publication] = publication }
  args = opts.order!(ARGV) {}
  opts.parse!(args)

  puts opts
  puts 'Start building csv...'
  puts '--------------------------------'

  base_url = options[:url]

  categories = [
    # {
    #   id: '2700',
    #   title: 'Medicine and Dentistry',
    #   publications: [
    #     {
    #       id: '321639',
    #       title: 'Annals of Oncology'
    #     },
    #     {
    #       id: '313527',
    #       title: 'Kidney International'
    #     },
    #     {
    #       id: '271007',
    #       title: 'Journal of Investigative Dermatology'
    #     },
    #     {
    #       id: '782964',
    #       title: 'American Journal of Transplantation'
    #     },
    #     {
    #       id: '271928',
    #       title: 'Biomedicine & Pharmacotherapy'
    #     },
    #     {
    #       id: '782959',
    #       title: 'Journal of Thrombosis and Haemostasis'
    #     },
    #     {
    #       id: '272508',
    #       title: 'NeuroImage'
    #     },
    #     {
    #       id: '271122',
    #       title: 'Vision Research'
    #     },
    #     {
    #       id: '312004',
    #       title: 'Clinical Microbiology and Infection'
    #     },
    #     {
    #       id: '272432',
    #       title: 'Respiratory Medicine'
    #     },
    #     {
    #       id: '272991',
    #       title: 'International Journal of Infectious Diseases'
    #     },
    #     {
    #       id: '318044',
    #       title: 'British Journal of Anaesthesia'
    #     },
    #     {
    #       id: '782701',
    #       title: 'Modern Pathology'
    #     },
    #     {
    #       id: '272926',
    #       title: 'Biology of Blood and Marrow Transplantation'
    #     },
    #     {
    #       id: '282794',
    #       title: 'NeuroImage, Clinical'
    #     },
    #     {
    #       id: '313381',
    #       title: 'Journal of Thoracic Oncology'
    #     },
    #     {
    #       id: '272474',
    #       title: 'Osteoarthritis and Cartilage'
    #     }
    #   ]
    # },
    # {
    #   id: '1300',
    #   title: 'Biochemistry, Genetics and Molecular Biology',
    #   publications: [
    #     {
    #       id: '778417',
    #       title: 'Journal of Biological Chemistry'
    #     },
    #     {
    #       id: '277708',
    #       title: 'Biophysical Journal'
    #     },
    #     {
    #       id: '272543',
    #       title: 'Developmental Biology'
    #     },
    #     {
    #       id: '272196',
    #       title: 'Cell'
    #     },
    #     {
    #       id: '272198',
    #       title: 'Molecular Cell'
    #     },
    #     {
    #       id: '778418',
    #       title: 'Journal of Lipid Research'
    #     },
    #     {
    #       id: '271033',
    #       title: 'Biochimica et Biophysica Acta (BBA) - Biomembranes'
    #     },
    #     {
    #       id: '778419',
    #       title: 'Molecular & Cellular Proteomics'
    #     },
    #     {
    #       id: '270195',
    #       title: 'Molecular Therapy'
    #     },
    #     {
    #       id: '272926',
    #       title: 'Biology of Blood and Marrow Transplantation'
    #     },
    #     {
    #       id: '311451',
    #       title: 'eBioMedicine'
    #     },
    #     {
    #       id: '272236',
    #       title: 'Developmental Cell'
    #     },
    #     {
    #       id: '272501',
    #       title: 'Genomics'
    #     },
    #     {
    #       id: '271023',
    #       title: 'Biochimica et Biophysica Acta (BBA) - Molecular Basis of Disease'
    #     },
    #     {
    #       id: '272027',
    #       title: 'Structure'
    #     },
    #     {
    #       id: '271024',
    #       title: 'Biochimica et Biophysica Acta (BBA) - Molecular Cell Research'
    #     },
    #     {
    #       id: '272099',
    #       title: 'Current Biology'
    #     },
    #     {
    #       id: '782706',
    #       title: 'Laboratory Investigation'
    #     },
    #     {
    #       id: '780143',
    #       title: 'Genetics in Medicine'
    #     },
    #     {
    #       id: '276895',
    #       title: 'The American Journal of Human Genetics'
    #     },
    #     {
    #       id: '271032',
    #       title: 'Biochimica et Biophysica Acta (BBA) - Bioenergetics'
    #     },
    #     {
    #       id: '282796',
    #       title: 'Redox Biology'
    #     },
    #     {
    #       id: '306540',
    #       title: 'Neoplasia'
    #     },
    #     {
    #       id: '272041',
    #       title: 'Experimental Hematology'
    #     },
    #     {
    #       id: '315508',
    #       title: 'Molecular Therapy - Nucleic Acids'
    #     }
    #   ]
    # },
    # {
    #   id: '2200',
    #   title: 'Engineering',
    #   publications: [
    #     {
    #       id: '278653',
    #       title: 'Procedia Engineering'
    #     },
    #     {
    #       id: '282173',
    #       title: 'Procedia CIRP'
    #     },
    #     {
    #       id: '271503',
    #       title: 'Computers & Mathematics with Applications'
    #     },
    #     {
    #       id: '278653',
    #       title: 'Procedia Manufacturing'
    #     },
    #     {
    #       id: '271589',
    #       title: 'Applied Mathematical Modelling'
    #     },
    #     {
    #       id: '271891',
    #       title: 'International Journal of Solids and Structures'
    #     },
    #     {
    #       id: '313059',
    #       title: 'Materials & Design'
    #     },
    #     {
    #       id: '271532',
    #       title: 'Applied Mathematics Letters'
    #     },
    #     {
    #       id: '270704',
    #       title: 'Alexandria Engineering Journal'
    #     },
    #     {
    #       id: '271552',
    #       title: 'Mathematical and Computer Modelling'
    #     },
    #     {
    #       id: '274151',
    #       title: 'Chinese Journal of Aeronautics'
    #     },
    #     {
    #       id: '282073',
    #       title: 'Procedia Technology'
    #     },
    #     {
    #       id: '278678',
    #       title: 'Journal of King Saud University - Science'
    #     },
    #     {
    #       id: '270550',
    #       title: 'Ain Shams Engineering Journal'
    #     },
    #     {
    #       id: '271429',
    #       title: 'Applied Energy'
    #     },
    #     {
    #       id: '286687',
    #       title: 'Journal of Rock Mechanics and Geotechnical Engineering'
    #     },
    #     {
    #       id: '305758',
    #       title: 'Defence Technology'
    #     },
    #     {
    #       id: '287527',
    #       title: 'Case Studies in Construction Materials'
    #     },
    #     {
    #       id: '305941',
    #       title: 'Engineering Science and Technology, an International Journal'
    #     },
    #     {
    #       id: '272263',
    #       title: 'Comptes Rendus MÃ©canique'
    #     },
    #     {
    #       id: '271585',
    #       title: 'Artificial Intelligence'
    #     },
    #     {
    #       id: '320278',
    #       title: 'Results in Engineering'
    #     },
    #     {
    #       id: '279952',
    #       title: 'Journal of Advanced Research'
    #     },
    #     {
    #       id: '282128',
    #       title: 'Soils and Foundations'
    #     },
    #     {
    #       id: '282170',
    #       title: 'International Journal of Mining Science and Technology'
    #     }
    #   ]
    # },
    # {
    #   id: '1100',
    #   title: 'Agricultural and Biological Sciences',
    #   publications: [
    #     {
    #       id: '279785',
    #       title: 'Journal of Dairy Science'
    #     },
    #     {
    #       id: '776861',
    #       title: 'Poultry Science'
    #     },
    #     {
    #       id: '782803',
    #       title: 'Journal of Food Protection'
    #     },
    #     {
    #       id: '778414',
    #       title: 'Animal'
    #     },
    #     {
    #       id: '272383',
    #       title: 'LWT'
    #     },
    #     {
    #       id: '272241',
    #       title: 'Ecological Indicators'
    #     },
    #     {
    #       id: '282494',
    #       title: 'Journal of Integrative Agriculture'
    #     },
    #     {
    #       id: '273500',
    #       title: 'South African Journal of Botany'
    #     },
    #     {
    #       id: '306541',
    #       title: 'Global Ecology and Conservation'
    #     },
    #     {
    #       id: '271032',
    #       title: 'Biochimica et Biophysica Acta (BBA) - Bioenergetics'
    #     },
    #     {
    #       id: '277412',
    #       title: 'Journal of Functional Foods'
    #     },
    #     {
    #       id: '776860',
    #       title: 'Journal of Applied Poultry Research'
    #     },
    #     {
    #       id: '311227',
    #       title: 'Aquaculture Reports'
    #     },
    #     {
    #       id: '272265',
    #       title: 'Comptes Rendus Biologies'
    #     },
    #     {
    #       id: '311979',
    #       title: 'Molecular Plant'
    #     },
    #     {
    #       id: '271102',
    #       title: 'FEBS Letters'
    #     },
    #     {
    #       id: '287972',
    #       title: 'Journal of Hydrology, Regional Studies'
    #     },
    #     {
    #       id: '271163',
    #       title: 'Food Chemistry'
    #     },
    #     {
    #       id: '287552',
    #       title: 'The Crop Journal'
    #     },
    #     {
    #       id: '271165',
    #       title: 'Food Research International'
    #     },
    #     {
    #       id: '273356',
    #       title: 'Limnologica'
    #     },
    #     {
    #       id: '271789',
    #       title: 'Geoderma'
    #     },
    #     {
    #       id: '270703',
    #       title: 'Agriculture and Agricultural Science Procedia'
    #     },
    #     {
    #       id: '279953',
    #       title: 'Field Mycology'
    #     }
    #   ]
    # },
    # {
    #   id: '1700',
    #   title: 'Computer Science',
    #   publications: [
    #     {
    #       id: '280203',
    #       title: 'Procedia Computer Science'
    #     },
    #     {
    #       id: '271503',
    #       title: 'Computers & Mathematics with Applications'
    #     },
    #     {
    #       id: '271538',
    #       title: 'Theoretical Computer Science'
    #     },
    #     {
    #       id: '271602',
    #       title: 'Discrete Applied Mathematics'
    #     },
    #     {
    #       id: '272990',
    #       title: 'Electronic Notes in Theoretical Computer Science'
    #     },
    #     {
    #       id: '282073',
    #       title: 'Procedia Technology'
    #     },
    #     {
    #       id: '272371',
    #       title: 'Journal of Biomedical Informatics'
    #     },
    #     {
    #       id: '280416',
    #       title: 'Journal of King Saud University - Computer and Information Sciences'
    #     },
    #     {
    #       id: '271600',
    #       title: 'Science of Computer Programming'
    #     },
    #     {
    #       id: '272574',
    #       title: 'Journal of Computer and System Sciences'
    #     },
    #     {
    #       id: '272313',
    #       title: 'Journal of Symbolic Computation'
    #     },
    #     {
    #       id: '272575',
    #       title: 'Information and Computation'
    #     },
    #     {
    #       id: '305941',
    #       title: 'Engineering Science and Technology, an International Journal'
    #     },
    #     {
    #       id: '271585',
    #       title: 'Artificial Intelligence'
    #     },
    #     {
    #       id: '312075',
    #       title: 'Informatics in Medicine Unlocked'
    #     },
    #     {
    #       id: '271512',
    #       title: 'Computational Geometry'
    #     },
    #     {
    #       id: '272975',
    #       title: 'Journal of Discrete Algorithms'
    #     },
    #     {
    #       id: '313521',
    #       title: 'ICT Express'
    #     },
    #     {
    #       id: '306123',
    #       title: 'Internet Interventions'
    #     },
    #     {
    #       id: '271700',
    #       title: 'European Journal of Operational Research'
    #     },
    #     {
    #       id: '271150',
    #       title: 'Computers in Biology and Medicine'
    #     },
    #     {
    #       id: '282178',
    #       title: 'IERI Procedia'
    #     },
    #     {
    #       id: '280962',
    #       title: 'Journal of the Egyptian Mathematical Society'
    #     },
    #     {
    #       id: '282179',
    #       title: 'AASRI Procedia'
    #     },
    #     {
    #       id: '272570',
    #       title: 'Journal of Computational Physics'
    #     }
    #   ]
    # },
    # {
    #   id: '2300',
    #   title: 'Environmental Science',
    #   publications: [
    #     {
    #       id: '271800',
    #       title: 'Science of The Total Environment'
    #     },
    #     {
    #       id: '272576',
    #       title: 'Ecotoxicology and Environmental Safety'
    #     },
    #     {
    #       id: '272241',
    #       title: 'Ecological Indicators'
    #     },
    #     {
    #       id: '271763',
    #       title: 'Environment International'
    #     },
    #     {
    #       id: '270397',
    #       title: 'Procedia Environmental Sciences'
    #     },
    #     {
    #       id: '278674',
    #       title: 'Saudi Journal of Biological Sciences'
    #     },
    #     {
    #       id: '306541',
    #       title: 'Global Ecology and Conservation'
    #     },
    #     {
    #       id: '271750',
    #       title: 'Journal of Cleaner Production'
    #     },
    #     {
    #       id: '311227',
    #       title: 'Aquaculture Reports'
    #     },
    #     {
    #       id: '305756',
    #       title: 'Toxicology Reports'
    #     },
    #     {
    #       id: '272261',
    #       title: 'Comptes Rendus Geoscience'
    #     },
    #     {
    #       id: '272637',
    #       title: 'International Journal of Applied Earth Observation and Geoinformation'
    #     },
    #     {
    #       id: '287972',
    #       title: 'Journal of Hydrology, Regional Studies'
    #     },
    #     {
    #       id: '271852',
    #       title: 'Chemosphere'
    #     },
    #     {
    #       id: '272592',
    #       title: 'Journal of Environmental Management'
    #     },
    #     {
    #       id: '272394',
    #       title: 'Environmental Research'
    #     },
    #     {
    #       id: '271942',
    #       title: 'Chemical Engineering Journal'
    #     },
    #     {
    #       id: '308311',
    #       title: 'Environmental Technology & Innovation'
    #     },
    #     {
    #       id: '271833',
    #       title: 'Environmental Pollution'
    #     },
    #     {
    #       id: '271745',
    #       title: 'Remote Sensing of Environment'
    #     },
    #     {
    #       id: '314106',
    #       title: 'International Journal of Naval Architecture and Ocean Engineering'
    #     },
    #     {
    #       id: '271768',
    #       title: 'Water Research'
    #     },
    #     {
    #       id: '273356',
    #       title: 'Limnologica'
    #     },
    #     {
    #       id: '271798',
    #       title: 'Atmospheric Environment'
    #     },
    #     {
    #       id: '271238',
    #       title: 'Agricultural Water Management'
    #     }
    #   ]
    # },
    # {
    #   id: '2500',
    #   title: 'Materials Science',
    #   publications: [
    #     {
    #       id: '277910',
    #       title: 'Energy Procedia'
    #     },
    #     {
    #       id: '286905',
    #       title: 'Journal of Materials Research and Technology'
    #     },
    #     {
    #       id: '313059',
    #       title: 'Materials & Design'
    #     },
    #     {
    #       id: '314029',
    #       title: 'Procedia Structural Integrity'
    #     },
    #     {
    #       id: '782049',
    #       title: 'Acta Crystallographica Section E Crystallographic Communications'
    #     },
    #     {
    #       id: '282606',
    #       title: 'Procedia Materials Science'
    #     },
    #     {
    #       id: '276826',
    #       title: 'Progress in Natural Science, Materials International'
    #     },
    #     {
    #       id: '308307',
    #       title: 'Nuclear Materials and Energy'
    #     },
    #     {
    #       id: '313777',
    #       title: 'Bioactive Materials'
    #     },
    #     {
    #       id: '286734',
    #       title: 'Journal of Magnesium and Alloys'
    #     },
    #     {
    #       id: '271545',
    #       title: 'Polymer Testing'
    #     },
    #     {
    #       id: '305927',
    #       title: 'Materials Today, Proceedings'
    #     },
    #     {
    #       id: '271533',
    #       title: 'Applied Surface Science'
    #     },
    #     {
    #       id: '782051',
    #       title: 'IUCrData'
    #     },
    #     {
    #       id: '273516',
    #       title: 'Transactions of Nonferrous Metals Society of China'
    #     },
    #     {
    #       id: '271635',
    #       title: 'Acta Materialia'
    #     },
    #     {
    #       id: '271472',
    #       title: 'International Journal of Hydrogen Energy'
    #     },
    #     {
    #       id: '271475',
    #       title: 'Construction and Building Materials'
    #     },
    #     {
    #       id: '312950',
    #       title: 'Journal of Materiomics'
    #     },
    #     {
    #       id: '271367',
    #       title: 'Journal of Power Sources'
    #     },
    #     {
    #       id: '273258',
    #       title: 'Acta Biomaterialia'
    #     },
    #     {
    #       id: '320038',
    #       title: 'Materials Today Bio'
    #     }
    #   ]
    # },
    # {
    #   id: '2800',
    #   title: 'Neuroscience',
    #   publications: [
    #     {
    #       id: '272543',
    #       title: 'Developmental Biology'
    #     },
    #     {
    #       id: '272196',
    #       title: 'Cell'
    #     },
    #     {
    #       id: '272195',
    #       title: 'Neuron'
    #     },
    #     {
    #       id: '272508',
    #       title: 'NeuroImage'
    #     },
    #     {
    #       id: '271122',
    #       title: 'Vision Research'
    #     },
    #     {
    #       id: '282794',
    #       title: 'NeuroImage, Clinical'
    #     },
    #     {
    #       id: '272099',
    #       title: 'Current Biology'
    #     },
    #     {
    #       id: '271242',
    #       title: 'Journal of Pain and Symptom Management'
    #     },
    #     {
    #       id: '272540',
    #       title: 'Seizure, European Journal of Epilepsy'
    #     },
    #     {
    #       id: '282671',
    #       title: 'Molecular Metabolism'
    #     },
    #     {
    #       id: '272509',
    #       title: 'Neurobiology of Disease'
    #     },
    #     {
    #       id: '271193',
    #       title: 'Mechanisms of Development'
    #     },
    #     {
    #       id: '280279',
    #       title: 'Developmental Cognitive Neuroscience'
    #     },
    #     {
    #       id: '276216',
    #       title: 'Stem Cell Research'
    #     },
    #     {
    #       id: '272045',
    #       title: 'Acta Psychologica'
    #     },
    #     {
    #       id: '280280',
    #       title: 'NeurologÃ­a'
    #     },
    #     {
    #       id: '270576',
    #       title: 'NeurologÃ­a (English Edition)'
    #     },
    #     {
    #       id: '271070',
    #       title: 'Neuropsychologia'
    #     },
    #     {
    #       id: '276827',
    #       title: 'Brain Stimulation'
    #     },
    #     {
    #       id: '271077',
    #       title: 'European Journal of Pharmacology'
    #     },
    #     {
    #       id: '271071',
    #       title: 'Neuroscience'
    #     },
    #     {
    #       id: '272489',
    #       title: 'Appetite'
    #     },
    #     {
    #       id: '276839',
    #       title: 'Cortex'
    #     },
    #     {
    #       id: '272555',
    #       title: 'Brain, Behavior, and Immunity'
    #     },
    #     {
    #       id: '776624',
    #       title: 'Brain, Behavior, & Immunity - Health'
    #     }
    #   ]
    # },
    {
      id: '2600',
      title: 'Mathematics',
      publications: [
        {
          id: '272578',
          title: 'Journal of Mathematical Analysis and Applications'
        },
        {
          id: '271610',
          title: 'Journal of Computational and Applied Mathematics'
        },
        {
          id: '272332',
          title: 'Journal of Algebra'
        },
        {
          id: '271586',
          title: 'Linear Algebra and its Applications'
        },
        {
          id: '271503',
          title: 'Computers & Mathematics with Applications'
        },
        {
          id: '271538',
          title: 'Theoretical Computer Science'
        },
        {
          id: '271589',
          title: 'Applied Mathematical Modelling'
        },
        {
          id: '272398',
          title: 'Journal of Differential Equations'
        },
        {
          id: '271536',
          title: 'Discrete Mathematics'
        },
        {
          id: '272585',
          title: 'Advances in Mathematics'
        },
        {
          id: '271523',
          title: 'Topology and its Applications'
        },
        {
          id: '271602',
          title: 'Discrete Applied Mathematics'
        },
        {
          id: '271532',
          title: 'Applied Mathematics Letters'
        },
        {
          id: '272990',
          title: 'Electronic Notes in Theoretical Computer Science'
        },
        {
          id: '272266',
          title: 'Comptes Rendus Mathematique'
        },
        {
          id: '272601',
          title: 'Journal of Functional Analysis'
        },
        {
          id: '271552',
          title: 'Mathematical and Computer Modelling'
        },
        {
          id: '271560',
          title: 'Nuclear Physics B'
        },
        {
          id: '272482',
          title: 'Journal of Number Theory'
        },
        {
          id: '272481',
          title: 'Journal of Multivariate Analysis'
        },
        {
          id: '272420',
          title: 'European Journal of Combinatorics'
        },
        {
          id: '271499',
          title: 'Stochastic Processes and their Applications'
        },
        {
          id: '271555',
          title: 'Journal of Geometry and Physics'
        },
        {
          id: '271593',
          title: 'Journal of Pure and Applied Algebra'
        },
        {
          id: '272565',
          title: 'Journal of Combinatorial Theory, Series A'
        }
      ]
    }
  ]

  categories.each do |category|
    category[:publications].each do |publication|
      (2003..2023).each do |year|
        url = base_url + "&subjectAreas=#{category[:id]}&publicationTitles=#{publication[:id]}&years=#{year}"
        while url
          puts "Processing url: #{url}"

          context = Scraper.new(url, year, publication[:title], category[:title], options[:output_file]).scrape
          sleep(3)
          puts '--------------------------------'
          if context && (url = context.next_url)
            puts 'Next!'
          else
            url = false
            puts "#{category[:title]} #{publication[:title]} #{year} Done!"
          end
        end
      end
    end
  end
end
